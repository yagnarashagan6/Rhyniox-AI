<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice-Reactive Mic Wave Animation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.10.2/lottie.min.js"></script>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: #000000; /* Dark background for better visibility */
      }

      #lottie-container {
        width: 400px;
        height: 400px;
      }

      /* Initial message for microphone permission */
      #status-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #ffffff;
        font-family: Arial, sans-serif;
        font-size: 1.2em;
        text-align: center;
      }

      /* Hide animation until microphone stream is ready */
      #lottie-container.hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="lottie-container" class="hidden"></div>
    <div id="status-message">Awaiting microphone permission...</div>

    <script>
      // 1. EMBEDDED LOTTIE JSON DATA
      // This is the content of the "Search Mic wave.json" file
      const animationData = {
        v: "4.8.0",
        meta: { g: "LottieFiles AE ", a: "", k: "", d: "", tc: "" },
        fr: 30,
        ip: 0,
        op: 173,
        w: 1080,
        h: 449,
        nm: "mic",
        ddd: 0,
        assets: [
          {
            id: "image_0",
            w: 338,
            h: 336,
            u: "",
            p: "data:image/png;base64,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i1V7lrTLvv0N23pLVCsQtdg2a+xq+TuisPCNv4VqosIw8C+/97ftvydFlDaQKkTPQhsJooZgCJcg6pBRBg0NwDAYi6Ge09KE7QLXoIUqMha9XmD72o5Xjg6MrGzXTnXSBlKJyE/kQ2n1g5i8a4ii/htWQwQUvvF9R1Sll69vGNhEBbz/X67/mzG0RSqlRhtQRPnMujcNlnjlATmIMhKIctglKhf03+ogmp4rFYgyhR6d8SnnWOkbpPWcgSiDX9/E+fX8s1B+YDrYFqH38F75t+f0pQWsQfhcveXe6YqvZQwvlyfqrqppvXGf8N5fX53H684c1w0H9n/B+Xp+d58c3w0H/H7z/jC/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P/J3T/jD/H888v/P3R7H91/Xm/v3yq9rJp/1D9F/W/7S8Yg2jG/pv/1P/y/4/8c/v/C//w==",
            ix: 10,
          },
        ],
        layers: [
          {
            ddd: 0,
            ind: 1,
            ty: 4,
            nm: "mic wave-wave",
            sr: 1,
            ks: {
              o: { a: 0, k: 100, ix: 11 },
              r: { a: 0, k: 0, ix: 10 },
              p: { a: 0, k: [541.678, 210.875, 0], ix: 2 },
              a: { a: 0, k: [540, 224.5, 0], ix: 1 },
              s: {
                a: 1,
                k: [
                  {
                    i: { x: 0.667, y: 1 },
                    o: { x: 0.333, y: 0 },
                    t: 0,
                    s: [100, 100, 100],
                  },
                  {
                    i: { x: 0.667, y: 1 },
                    o: { x: 0.333, y: 0 },
                    t: 13,
                    s: [100, 100, 100],
                  },
                  {
                    i: { x: 0.667, y: 1 },
                    o: { x: 0.333, y: 0 },
                    t: 30,
                    s: [100, 21, 100],
                  },
                  {
                    i: { x: 0.667, y: 1 },
                    o: { x: 0.333, y: 0 },
                    t: 58,
                    s: [100, 100, 100],
                  },
                  {
                    i: { x: 0.667, y: 1 },
                    o: { x: 0.333, y: 0 },
                    t: 78,
                    s: [100, 43, 100],
                  },
                  {
                    i: { x: 0.667, y: 1 },
                    o: { x: 0.333, y: 0 },
                    t: 105,
                    s: [100, 100, 100],
                  },
                  {
                    i: { x: 0.667, y: 1 },
                    o: { x: 0.333, y: 0 },
                    t: 129,
                    s: [100, 31, 100],
                  },
                  {
                    i: { x: 0.667, y: 1 },
                    o: { x: 0.333, y: 0 },
                    t: 154,
                    s: [100, 99, 100],
                  },
                  { t: 157, s: [100, 48, 100] },
                ],
                ix: 6,
              },
            },
            ao: 0,
            hasMask: true,
            masksProperties: [],
            refId: "image_0",
            cl: "mic wave-wave",
          },
        ],
        nm: "Search Mic wave",
        op: 173,
      };

      // 2. WEB AUDIO & LOTTIE LOGIC
      let lottieAnimation = null;
      let audioContext = null;
      let analyser = null;
      let dataArray = null;

      function initLottie() {
        const container = document.getElementById("lottie-container");

        // The animation must start paused (speed 0)
        lottieAnimation = lottie.loadAnimation({
          container: container,
          renderer: "svg",
          loop: true,
          autoplay: true, // Auto-play starts the loop, but we immediately set speed to 0
          animationData: animationData,
        });

        // Set initial speed to 0 so it's "without moving"
        lottieAnimation.setSpeed(0);

        // Show animation container once loaded
        lottieAnimation.addEventListener("DOMLoaded", () => {
          document.getElementById("status-message").remove();
          container.classList.remove("hidden");
        });
      }

      async function initAudio() {
        try {
          // Request microphone access
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });

          // Setup Audio Context and Analyser
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          analyser = audioContext.createAnalyser();
          const source = audioContext.createMediaStreamSource(stream);

          source.connect(analyser);
          analyser.fftSize = 256; // Fast Fourier Transform size
          const bufferLength = analyser.frequencyBinCount;
          dataArray = new Uint8Array(bufferLength);

          // Start the animation and volume check loop
          if (!lottieAnimation) initLottie();

          // Only start the loop after Lottie is ready, to ensure lottieAnimation exists
          if (lottieAnimation) {
            lottieAnimation.play();
            checkVolume();
          } else {
            console.error("Lottie animation failed to initialize.");
          }
        } catch (err) {
          console.error("Error accessing microphone:", err);
          document.getElementById("status-message").innerText =
            "Microphone access denied or failed. The animation is stationary.";
          if (!lottieAnimation) initLottie();
        }
      }

      function checkVolume() {
        if (analyser && dataArray) {
          analyser.getByteFrequencyData(dataArray);

          // Calculate the average amplitude (volume)
          let sum = 0;
          for (let i = 0; i < dataArray.length; i++) {
            sum += dataArray[i];
          }
          const averageAmplitude = sum / dataArray.length;

          // Map amplitude to Lottie speed:
          // Max speed of 2.5 (250% of original speed)
          const MAX_SPEED = 2.5;
          // A minimum amplitude threshold (quiet room noise)
          const QUIET_THRESHOLD = 20;
          // The amplitude level we treat as "full volume" for max speed
          const MAX_VOLUME_LEVEL = 70;

          let normalizedVolume = Math.max(
            0,
            averageAmplitude - QUIET_THRESHOLD
          );
          let speed = (normalizedVolume / MAX_VOLUME_LEVEL) * MAX_SPEED;

          // Clamp the speed to prevent excessively high values
          speed = Math.min(speed, MAX_SPEED);

          // Apply a small minimum speed (e.g., 0.1) so the animation doesn't look completely frozen
          // in a quiet room, or use 0 to strictly meet the "without moving" requirement.
          const MIN_SPEED = 0.0;
          speed = Math.max(MIN_SPEED, speed);

          lottieAnimation.setSpeed(speed);
        }

        // Continue the loop for real-time updates
        requestAnimationFrame(checkVolume);
      }

      // Start the process
      initAudio();
    </script>
  </body>
</html>
